Some design considerations:

Key principle: each manipulation to be done where it's easiest to do it, i.e. don't try to solve everything during the single-pass HTML parsing (many things are just easier to do as a manipulation of the clean markdown)


